{{/*
Shared secret for auth-server and registry.
Generates random values if not provided via global values.
Both services reference this single secret for SECRET_KEY and federation tokens.
*/}}
{{- $secretName := .Values.global.sharedSecretName | default "shared-secret" }}
{{- $existingSecret := lookup "v1" "Secret" .Release.Namespace $secretName }}
{{- $secretKey := "" }}
{{- if .Values.global.secretKey }}
  {{- $secretKey = .Values.global.secretKey }}
{{- else if $existingSecret }}
  {{- $secretKey = index $existingSecret.data "SECRET_KEY" | b64dec }}
{{- else }}
  {{- $secretKey = randAlphaNum 64 }}
{{- end }}
{{- /* Resolve federation values */ -}}
{{- $federationEnabled := false }}
{{- $federationStaticTokenRaw := "" }}
{{- $federationEncryptionKeyRaw := "" }}
{{- $registryId := "" }}
{{- if .Values.global.federation }}
  {{- $federationEnabled = .Values.global.federation.staticTokenAuthEnabled | default false }}
  {{- $federationStaticTokenRaw = .Values.global.federation.staticToken | default "" }}
  {{- $federationEncryptionKeyRaw = .Values.global.federation.encryptionKey | default "" }}
  {{- $registryId = .Values.global.federation.registryId | default "" }}
{{- end }}
{{- /* Reuse existing values from secret on upgrade, or generate new ones */ -}}
{{- $federationStaticToken := "" }}
{{- $federationEncryptionKey := "" }}
{{- if $federationStaticTokenRaw }}
  {{- $federationStaticToken = $federationStaticTokenRaw }}
{{- else if and $existingSecret (index $existingSecret.data "FEDERATION_STATIC_TOKEN") }}
  {{- $federationStaticToken = index $existingSecret.data "FEDERATION_STATIC_TOKEN" | b64dec }}
{{- else }}
  {{- $federationStaticToken = randBytes 32 | replace "+" "-" | replace "/" "_" | trimSuffix "=" }}
{{- end }}
{{- if $federationEncryptionKeyRaw }}
  {{- $federationEncryptionKey = $federationEncryptionKeyRaw }}
{{- else if and $existingSecret (index $existingSecret.data "FEDERATION_ENCRYPTION_KEY") }}
  {{- $federationEncryptionKey = index $existingSecret.data "FEDERATION_ENCRYPTION_KEY" | b64dec }}
{{- else }}
  {{- $federationEncryptionKey = randBytes 32 }}
{{- end }}
apiVersion: v1
kind: Secret
metadata:
  name: {{ $secretName }}
  namespace: {{ .Release.Namespace | quote }}
  labels:
    {{- include "mcp-gateway-registry-stack.labels" . | nindent 4 }}
type: Opaque
data:
  SECRET_KEY: {{ $secretKey | b64enc | quote }}
  {{- if $federationEnabled }}
  FEDERATION_STATIC_TOKEN_AUTH_ENABLED: {{ $federationEnabled | toString | b64enc | quote }}
  FEDERATION_STATIC_TOKEN: {{ $federationStaticToken | b64enc | quote }}
  FEDERATION_ENCRYPTION_KEY: {{ $federationEncryptionKey | b64enc | quote }}
  {{- end }}
  {{- if $registryId }}
  REGISTRY_ID: {{ $registryId | b64enc | quote }}
  {{- end }}
