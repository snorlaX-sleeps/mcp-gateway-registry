{{- $routingMode := .Values.global.ingress.routingMode | default "subdomain" }}
{{- $domain := .Values.global.domain | default "localhost" }}
{{- $protocol := ternary "https" "http" .Values.global.ingress.tls }}
{{- $authServerPath := .Values.global.ingress.paths.authServer | default "/auth-server" }}
{{- $registryPath := .Values.global.ingress.paths.registry | default "/registry" }}
{{- $keycloakPath := .Values.global.ingress.paths.keycloak | default "/keycloak" }}
{{- $authServerExternalUrl := "" }}
{{- $registryExternalUrl := "" }}
{{- $keycloakUrl := printf "http://%s-keycloak-headless.%s.svc.cluster.local:8080" .Release.Name .Release.Namespace}}
{{- $rootPath := "" }}
{{- $gatewayAdditionalServerNames := $domain}}
{{- if eq $routingMode "path" }}
  {{- $authServerExternalUrl = printf "%s://%s%s" $protocol $domain $authServerPath }}
  {{- $registryExternalUrl = printf "%s://%s%s" $protocol $domain $registryPath }}
  {{- $keycloakUrl = printf "%s%s" $keycloakUrl $keycloakPath }}
  {{- $rootPath = $registryPath }}
{{- else }}
  {{- $authServerExternalUrl = printf "%s://auth-server.%s" $protocol $domain }}
  {{- $registryExternalUrl = printf "%s://mcpregistry.%s" $protocol $domain }}
  {{- $gatewayAdditionalServerNames = printf "mcpregistry.%s" $domain }}
{{- end }}
{{- /* Auto-generate federation tokens if not provided */ -}}
{{- /* Resolve federation values - prefer global, fallback to local app values */ -}}
{{- $federationEnabled := .Values.app.federationStaticTokenAuthEnabled | default false }}
{{- if .Values.global.federation }}
  {{- $federationEnabled = .Values.global.federation.staticTokenAuthEnabled | default $federationEnabled }}
{{- end }}
{{- $federationStaticTokenRaw := .Values.app.federationStaticToken }}
{{- $federationEncryptionKeyRaw := .Values.app.federationEncryptionKey }}
{{- $registryId := .Values.app.registryId }}
{{- if .Values.global.federation }}
  {{- $federationStaticTokenRaw = .Values.global.federation.staticToken | default $federationStaticTokenRaw }}
  {{- $federationEncryptionKeyRaw = .Values.global.federation.encryptionKey | default $federationEncryptionKeyRaw }}
  {{- $registryId = .Values.global.federation.registryId | default $registryId }}
{{- end }}
{{- /* Generate URL-safe token (equivalent to secrets.token_urlsafe(32)) */ -}}
{{- $federationStaticToken := $federationStaticTokenRaw | default (randBytes 32 | replace "+" "-" | replace "/" "_" | trimSuffix "=") }}
{{- /* Generate Fernet-compatible key (32 random bytes, base64-encoded) */ -}}
{{- $federationEncryptionKey := $federationEncryptionKeyRaw | default (randBytes 32) }}
apiVersion: v1
kind: Secret
metadata:
  name: {{ .Values.app.envSecretName }}
  namespace: {{ .Release.Namespace | quote }}
data:
  ADMIN_PASSWORD: {{ randAlphaNum 64 | b64enc | quote }}
  AUTH_PROVIDER: {{ (.Values.global.authProvider.type | default "keycloak") | b64enc | quote }}
  AUTH_SERVER_EXTERNAL_URL: {{ $authServerExternalUrl | b64enc | quote }}
  AUTH_SERVER_URL: {{ printf "http://auth-server.%s.svc.cluster.local:8888" .Release.Namespace | b64enc | quote }}
  {{- if eq (.Values.global.authProvider.type | default "keycloak") "keycloak" }}
  KEYCLOAK_URL: {{ $keycloakUrl | b64enc | quote }}
  {{- end }}
  GATEWAY_ADDITIONAL_SERVER_NAMES: {{ $gatewayAdditionalServerNames| b64enc | quote }}
  ROOT_PATH: {{ $rootPath | b64enc | quote }}
{{- if not .Values.global.sharedSecretName }}
  {{/* Federation and SECRET_KEY managed per-chart in standalone deployment */}}
  {{- if $federationEnabled }}
  FEDERATION_STATIC_TOKEN_AUTH_ENABLED: {{ $federationEnabled | toString | b64enc | quote }}
  FEDERATION_STATIC_TOKEN: {{ $federationStaticToken | b64enc | quote }}
  FEDERATION_ENCRYPTION_KEY: {{ $federationEncryptionKey | b64enc | quote }}
  {{- end }}
  {{- if $registryId }}
  REGISTRY_ID: {{ $registryId | b64enc | quote }}
  {{- end }}
  {{/* SECRET_KEY required for standalone deployment - must match auth-server's key */}}
  SECRET_KEY: {{ required "app.secretKey or global.secretKey is required for standalone deployment" (.Values.global.secretKey | default .Values.app.secretKey) | b64enc | quote }}
{{- end }}
